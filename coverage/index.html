<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Midori-contrib</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.10.1/application.js' type='text/javascript'></script>    
    <link href='./assets/0.10.1/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.10.1/favicon_green.png" />
    <link rel="icon" type="image/png" href="./assets/0.10.1/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.10.1/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2017-06-14T23:34:56+08:00">2017-06-14T23:34:56+08:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="green">92.8%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         6.01
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>5</b> files in total.
    <b>125</b> relevant lines. 
    <span class="green"><b>116</b> lines covered</span> and
    <span class="red"><b>9</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#f91d5f71698e4807343f7975c2804098e5d76120" class="src_link" title="lib/midori-contrib/file.rb">lib/midori-contrib/file.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>51</td>
        <td>23</td>
        <td>23</td>
        <td>0</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#214348b996630b3a42edd5cd8bbf3961d5576848" class="src_link" title="lib/midori-contrib/net.rb">lib/midori-contrib/net.rb</a></td>
        <td class="red strong">30.77 %</td>
        <td>42</td>
        <td>13</td>
        <td>4</td>
        <td>9</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8b8624bd93a32c75319f92b86a7c223588696b60" class="src_link" title="lib/midori-contrib/redic.rb">lib/midori-contrib/redic.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>99</td>
        <td>47</td>
        <td>47</td>
        <td>0</td>
        <td>3.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1f5d9ebdbf316a77609fdf60e9687dd1d732d4ef" class="src_link" title="lib/midori-contrib/sequel/mysql2.rb">lib/midori-contrib/sequel/mysql2.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>111</td>
        <td>23</td>
        <td>23</td>
        <td>0</td>
        <td>18.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#633856cfdc4bc6b76e7f0e3fb4f8e409fb990eb2" class="src_link" title="lib/midori-contrib/sequel/postgres.rb">lib/midori-contrib/sequel/postgres.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>45</td>
        <td>19</td>
        <td>19</td>
        <td>0</td>
        <td>8.2</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.14.1 
        and simplecov-html v0.10.1<br/>
        using RSpec
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="f91d5f71698e4807343f7975c2804098e5d76120">
  <div class="header">
    <h3>lib/midori-contrib/file.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>23</b> relevant lines. 
      <span class="green"><b>23</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Midori Extension of File reading and writing</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Midori::File</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # Init File object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # @param [Array] args same args like File.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(*args)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="7">
          <span class="hits">4</span>
          
          <code class="ruby">    @file = File.new(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # read file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @return [String] string readed</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def read</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    await(Promise.new do |resolve|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      data = &#39;&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      EventLoop.register(@file, :r) do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">        if @file.eof?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">          EventLoop.deregister(@file)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">          resolve.call(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">          data &lt;&lt; @file.read_nonblock(16384)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # write file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  # @param [String] data string to be written</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def write(data)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    await(Promise.new do |resolve|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">      written = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      EventLoop.register(@file, :w) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">        written += @file.write_nonblock(data[written..-1])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">        if written == data.size</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">          EventLoop.deregister(@file)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">          resolve.call(written)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # raw file object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # @return [File] file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def raw</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    @file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  # Close the file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def close</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="49">
          <span class="hits">3</span>
          
          <code class="ruby">    @file.close</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="214348b996630b3a42edd5cd8bbf3961d5576848">
  <div class="header">
    <h3>lib/midori-contrib/net.rb</h3>
    <h4><span class="red">30.77 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;net/protocol&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># Meta programming Net class for async HTTP and FTP connection</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">class Net::BufferedIO</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Wait till io finishes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @param [Symbol] interest</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def wait_io(interest)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    await(Promise.new do |resolve|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      io = @io.to_io</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      EventLoop.register(io, interest) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        EventLoop.deregister(io)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">        resolve.call(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # Fill until the operation finishes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def rbuf_fill</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    loop do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      case rv = @io.read_nonblock(BUFSIZE, exception: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        when String</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">          return @rbuf &lt;&lt; rv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        when :wait_readable</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          wait_io(:r)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        # @io.to_io.wait_readable(@read_timeout) or raise Net::ReadTimeout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        # continue looping</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        when :wait_writable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          # OpenSSL::Buffering#read_nonblock may fail with IO::WaitWritable.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">          # http://www.openssl.org/support/faq.html#PROG10</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="31">
          
          <span class="hits">skipped</span>
          <code class="ruby">          # :nocov:</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="32">
          
          <span class="hits">skipped</span>
          <code class="ruby">          wait_io(:w)</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="33">
          
          <span class="hits">skipped</span>
          <code class="ruby">        # @io.to_io.wait_writable(@read_timeout) or raise Net::ReadTimeout</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="34">
          
          <span class="hits">skipped</span>
          <code class="ruby">        # continue looping</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="35">
          
          <span class="hits">skipped</span>
          <code class="ruby">        when nil</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="36">
          
          <span class="hits">skipped</span>
          <code class="ruby">          # callers do not care about backtrace, so avoid allocating for it</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="37">
          
          <span class="hits">skipped</span>
          <code class="ruby">          raise EOFError, &#39;end of file reached&#39;, []</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="38">
          
          <span class="hits">skipped</span>
          <code class="ruby">        # :nocov:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8b8624bd93a32c75319f92b86a7c223588696b60">
  <div class="header">
    <h3>lib/midori-contrib/redic.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>47</b> relevant lines. 
      <span class="green"><b>47</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Meta-programming hiredis for redis async extension</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Hiredis</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  require &#39;hiredis/connection&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # Overwrite with ruby implementation to hook IO</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  require &#39;hiredis/ruby/connection&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  require &#39;hiredis/ruby/reader&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Redis Connection</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  Connection = Ruby::Connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Redis Result Reader</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  Reader = Ruby::Reader</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # Meta-programming hiredis for redis async extension</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  module Ruby</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # Meta-programming hiredis for redis async extension</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    class Connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      # Do redis query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # @param [Array] args equal to Hiredis write args</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def query(args)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="22">
          <span class="hits">2</span>
          
          <code class="ruby">        await(Promise.new do |resolve|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="23">
          <span class="hits">2</span>
          
          <code class="ruby">          read_flag = false</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">          data = pre_write(args)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">          written = 0</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="26">
          <span class="hits">2</span>
          
          <code class="ruby">          EventLoop.register(@sock, :rw) do |monitor|</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="27">
          <span class="hits">29</span>
          
          <code class="ruby">            if read_flag &amp;&amp; monitor.readable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">              # Reading</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="29">
          <span class="hits">2</span>
          
          <code class="ruby">              _read(resolve, @sock)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="31">
          <span class="hits">29</span>
          
          <code class="ruby">            if !read_flag &amp;&amp; monitor.writable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">              # Writing</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="33">
          <span class="hits">2</span>
          
          <code class="ruby">              written += @sock.write_nonblock(data[written..-1])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="34">
          <span class="hits">2</span>
          
          <code class="ruby">              read_flag = true if written == string_size(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        end)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">        def pre_write(args)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="42">
          <span class="hits">2</span>
          
          <code class="ruby">          command = []</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="43">
          <span class="hits">2</span>
          
          <code class="ruby">          command &lt;&lt; &quot;*#{args.size}&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="44">
          <span class="hits">2</span>
          
          <code class="ruby">          args.each do |arg|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="45">
          <span class="hits">5</span>
          
          <code class="ruby">            arg = arg.to_s</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="46">
          <span class="hits">5</span>
          
          <code class="ruby">            command &lt;&lt; &quot;$#{string_size arg}&quot;</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="47">
          <span class="hits">5</span>
          
          <code class="ruby">            command &lt;&lt; arg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="49">
          <span class="hits">2</span>
          
          <code class="ruby">          data = command.join(COMMAND_DELIMITER) + COMMAND_DELIMITER</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="50">
          <span class="hits">2</span>
          
          <code class="ruby">          data.force_encoding(&#39;binary&#39;) if data.respond_to?(:force_encoding)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="51">
          <span class="hits">2</span>
          
          <code class="ruby">          data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">        def _read(resolve, sock)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="55">
          <span class="hits">2</span>
          
          <code class="ruby">          @reader.feed @sock.read_nonblock(1024)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="56">
          <span class="hits">2</span>
          
          <code class="ruby">          reply = @reader.gets</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="57">
          <span class="hits">2</span>
          
          <code class="ruby">          if reply</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="58">
          <span class="hits">2</span>
          
          <code class="ruby">            EventLoop.deregister(sock)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">            resolve.call(reply)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;redic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"># Meta-programming Redic for redis async extension</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">class Redic</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  # Meta-programming Redic for redis async extension</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  class Client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    # Connect redis, yield optional</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="75">
          <span class="hits">2</span>
          
          <code class="ruby">      establish_connection unless connected?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="76">
          <span class="hits">2</span>
          
          <code class="ruby">      if block_given?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        # Redic default yield</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="78">
          
          <span class="hits">skipped</span>
          <code class="ruby">        # :nocov:</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="79">
          
          <span class="hits">skipped</span>
          <code class="ruby">        @semaphore.synchronize do</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="80">
          
          <span class="hits">skipped</span>
          <code class="ruby">          yield</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="81">
          
          <span class="hits">skipped</span>
          <code class="ruby">        end</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="82">
          
          <span class="hits">skipped</span>
          <code class="ruby">        # :nocov:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    # Call without thread lock</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    # @param [Array] args same params as Redic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    def call(*args)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="89">
          <span class="hits">2</span>
          
          <code class="ruby">      @connection.query(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  # Call without thread lock</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  # @param [Array] args same params as Redic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  def call(*args)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="96">
          <span class="hits">2</span>
          
          <code class="ruby">    @client.connect</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">    @client.call(args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1f5d9ebdbf316a77609fdf60e9687dd1d732d4ef">
  <div class="header">
    <h3>lib/midori-contrib/sequel/mysql2.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>23</b> relevant lines. 
      <span class="green"><b>23</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">safe_require &#39;sequel&#39;, &#39;gem install sequel&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;sequel/adapters/mysql2&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># Management of MySQL Sockets</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">MYSQL_SOCKETS = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># Meta-programming Sequel for async extensions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">module Sequel</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Midori Extension of sequel MySQL through meta programming</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  module Mysql2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # Midori Extension of sequel MySQL through meta programming</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    class Database</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # Execute the given SQL on the given connection.  If the :type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # option is :select, yield the result of the query, otherwise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      # yield the connection if a block is given.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # @param [Mysql2::Client] conn connection to database</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # @param [String] sql sql query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      # @param [Hash] opts optional options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # @return [Mysql2::Result] MySQL results</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def _execute(conn, sql, opts) # rubocop:disable Metrics/MethodLength, Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="22">
          <span class="hits">17</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="23">
          
          <span class="hits">skipped</span>
          <code class="ruby">          # :nocov:</code>
        </li>
      
        <li class="skipped" data-hits="17" data-linenumber="24">
          
          <span class="hits">skipped</span>
          <code class="ruby">          stream = opts[:stream]</code>
        </li>
      
        <li class="skipped" data-hits="17" data-linenumber="25">
          
          <span class="hits">skipped</span>
          <code class="ruby">          if NativePreparedStatements</code>
        </li>
      
        <li class="skipped" data-hits="17" data-linenumber="26">
          
          <span class="hits">skipped</span>
          <code class="ruby">            if (args = opts[:arguments])</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="27">
          
          <span class="hits">skipped</span>
          <code class="ruby">              args = args.map{|arg| bound_variable_value(arg)}</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="28">
          
          <span class="hits">skipped</span>
          <code class="ruby">            end</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="29">
          
          <span class="hits">skipped</span>
          <code class="ruby"></code>
        </li>
      
        <li class="skipped" data-hits="17" data-linenumber="30">
          
          <span class="hits">skipped</span>
          <code class="ruby">            case sql</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="31">
          
          <span class="hits">skipped</span>
          <code class="ruby">              when ::Mysql2::Statement</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="32">
          
          <span class="hits">skipped</span>
          <code class="ruby">                stmt = sql</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="33">
          
          <span class="hits">skipped</span>
          <code class="ruby">              when Dataset</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="34">
          
          <span class="hits">skipped</span>
          <code class="ruby">                sql = sql.sql</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="35">
          
          <span class="hits">skipped</span>
          <code class="ruby">                close_stmt = true</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="36">
          
          <span class="hits">skipped</span>
          <code class="ruby">                stmt = conn.prepare(sql)</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="37">
          
          <span class="hits">skipped</span>
          <code class="ruby">            end</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="38">
          
          <span class="hits">skipped</span>
          <code class="ruby">          end</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="39">
          
          <span class="hits">skipped</span>
          <code class="ruby"></code>
        </li>
      
        <li class="skipped" data-hits="17" data-linenumber="40">
          
          <span class="hits">skipped</span>
          <code class="ruby">          r = log_connection_yield((log_sql = opts[:log_sql]) ? sql + log_sql : sql, conn, args) do</code>
        </li>
      
        <li class="skipped" data-hits="17" data-linenumber="41">
          
          <span class="hits">skipped</span>
          <code class="ruby">            if stmt</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="42">
          
          <span class="hits">skipped</span>
          <code class="ruby">              conn.query_options.merge!(cache_rows: true,</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="43">
          
          <span class="hits">skipped</span>
          <code class="ruby">                                        database_timezone: timezone,</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="44">
          
          <span class="hits">skipped</span>
          <code class="ruby">                                        application_timezone: Sequel.application_timezone,</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="45">
          
          <span class="hits">skipped</span>
          <code class="ruby">                                        stream: stream,</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="46">
          
          <span class="hits">skipped</span>
          <code class="ruby">                                        cast_booleans: convert_tinyint_to_bool)</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="47">
          
          <span class="hits">skipped</span>
          <code class="ruby">              stmt.execute(*args)</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="48">
          
          <span class="hits">skipped</span>
          <code class="ruby">              # :nocov:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="50">
          <span class="hits">17</span>
          
          <code class="ruby">              if MYSQL_SOCKETS[conn.socket].nil?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="51">
          <span class="hits">3</span>
          
          <code class="ruby">                MYSQL_SOCKETS[conn.socket] = IO::open(conn.socket)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="53">
          <span class="hits">17</span>
          
          <code class="ruby">              socket = MYSQL_SOCKETS[conn.socket]</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="54">
          <span class="hits">17</span>
          
          <code class="ruby">              await(Promise.new do |resolve|</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="55">
          <span class="hits">17</span>
          
          <code class="ruby">                count = 0</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="56">
          <span class="hits">17</span>
          
          <code class="ruby">                EventLoop.register(socket, :rw) do</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="57">
          <span class="hits">34</span>
          
          <code class="ruby">                  if (count == 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">                    # Writable</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="59">
          <span class="hits">17</span>
          
          <code class="ruby">                    count += 1</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="60">
          <span class="hits">17</span>
          
          <code class="ruby">                    conn.query(sql,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">                              database_timezone: timezone,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">                              application_timezone: Sequel.application_timezone,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">                              stream: stream,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">                              async: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">                  else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">                    # Readable</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="67">
          <span class="hits">17</span>
          
          <code class="ruby">                    begin</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="68">
          <span class="hits">17</span>
          
          <code class="ruby">                      EventLoop.deregister(socket)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="69">
          <span class="hits">17</span>
          
          <code class="ruby">                      resolve.call(conn.async_result)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">                    rescue ::Mysql2::Error =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">                      resolve.call(PromiseException.new(e))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">                      next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">                    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">                  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">              end)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="80">
          
          <span class="hits">skipped</span>
          <code class="ruby">          # :nocov:</code>
        </li>
      
        <li class="skipped" data-hits="16" data-linenumber="81">
          
          <span class="hits">skipped</span>
          <code class="ruby">          if opts[:type] == :select</code>
        </li>
      
        <li class="skipped" data-hits="3" data-linenumber="82">
          
          <span class="hits">skipped</span>
          <code class="ruby">            if r</code>
        </li>
      
        <li class="skipped" data-hits="3" data-linenumber="83">
          
          <span class="hits">skipped</span>
          <code class="ruby">              if stream</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="84">
          
          <span class="hits">skipped</span>
          <code class="ruby">                begin</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="85">
          
          <span class="hits">skipped</span>
          <code class="ruby">                  r2 = yield r</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="86">
          
          <span class="hits">skipped</span>
          <code class="ruby">                ensure</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="87">
          
          <span class="hits">skipped</span>
          <code class="ruby">                  # If r2 is nil, it means the block did not exit normally,</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="88">
          
          <span class="hits">skipped</span>
          <code class="ruby">                  # so the rest of the results must be drained to prevent</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="89">
          
          <span class="hits">skipped</span>
          <code class="ruby">                  # &quot;commands out of sync&quot; errors.</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="90">
          
          <span class="hits">skipped</span>
          <code class="ruby">                  r.each{} unless r2</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="91">
          
          <span class="hits">skipped</span>
          <code class="ruby">                end</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="92">
          
          <span class="hits">skipped</span>
          <code class="ruby">              else</code>
        </li>
      
        <li class="skipped" data-hits="3" data-linenumber="93">
          
          <span class="hits">skipped</span>
          <code class="ruby">                yield r</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="94">
          
          <span class="hits">skipped</span>
          <code class="ruby">              end</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="95">
          
          <span class="hits">skipped</span>
          <code class="ruby">            end</code>
        </li>
      
        <li class="skipped" data-hits="13" data-linenumber="96">
          
          <span class="hits">skipped</span>
          <code class="ruby">          elsif block_given?</code>
        </li>
      
        <li class="skipped" data-hits="13" data-linenumber="97">
          
          <span class="hits">skipped</span>
          <code class="ruby">            yield conn</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="98">
          
          <span class="hits">skipped</span>
          <code class="ruby">          end</code>
        </li>
      
        <li class="skipped" data-hits="1" data-linenumber="99">
          
          <span class="hits">skipped</span>
          <code class="ruby">        rescue ::Mysql2::Error =&gt; e</code>
        </li>
      
        <li class="skipped" data-hits="1" data-linenumber="100">
          
          <span class="hits">skipped</span>
          <code class="ruby">          raise_error(e)</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="101">
          
          <span class="hits">skipped</span>
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="skipped" data-hits="17" data-linenumber="102">
          
          <span class="hits">skipped</span>
          <code class="ruby">          if stmt</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="103">
          
          <span class="hits">skipped</span>
          <code class="ruby">            conn.query_options.replace(conn.instance_variable_get(:@sequel_default_query_options))</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="104">
          
          <span class="hits">skipped</span>
          <code class="ruby">            stmt.close if close_stmt</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="105">
          
          <span class="hits">skipped</span>
          <code class="ruby">          end</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="106">
          
          <span class="hits">skipped</span>
          <code class="ruby">          # :nocov:</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="107">
          <span class="hits">17</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="633856cfdc4bc6b76e7f0e3fb4f8e409fb990eb2">
  <div class="header">
    <h3>lib/midori-contrib/sequel/postgres.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">safe_require &#39;sequel&#39;, &#39;gem install sequel&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;sequel/adapters/postgres&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># Management of Postgres Sockets</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">POSTGRES_SOCKETS = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># Midori Extension of sequel postgres through meta programming</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">class Sequel::Postgres::Adapter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Call a sql request asynchronously</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @param [String] sql sql request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @param [Array] args args to send</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # @return [Array] sql query result</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def execute_query(sql, args)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="15">
          <span class="hits">10</span>
          
          <code class="ruby">    @db.log_connection_yield(sql, self, args) do</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="16">
          <span class="hits">10</span>
          
          <code class="ruby">      if POSTGRES_SOCKETS[self].nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">        POSTGRES_SOCKETS[self] = IO::open(socket)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="19">
          <span class="hits">10</span>
          
          <code class="ruby">      socket_object = POSTGRES_SOCKETS[self]</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="20">
          <span class="hits">10</span>
          
          <code class="ruby">      await(Promise.new do |resolve|</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="21">
          <span class="hits">10</span>
          
          <code class="ruby">        count = 0</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="22">
          <span class="hits">10</span>
          
          <code class="ruby">        EventLoop.register(socket_object, :rw) do</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="23">
          <span class="hits">20</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="24">
          <span class="hits">20</span>
          
          <code class="ruby">            if (count == 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">              # Writable</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="26">
          <span class="hits">10</span>
          
          <code class="ruby">              unless is_busy</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="27">
          <span class="hits">10</span>
          
          <code class="ruby">                send_query(sql)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="28">
          <span class="hits">10</span>
          
          <code class="ruby">                count += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">              # Readable</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="32">
          <span class="hits">10</span>
          
          <code class="ruby">              EventLoop.deregister(socket_object)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="33">
          <span class="hits">10</span>
          
          <code class="ruby">              resolve.call(get_result)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          # For extra errors</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="36">
          
          <span class="hits">skipped</span>
          <code class="ruby">          # :nocov:</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="37">
          
          <span class="hits">skipped</span>
          <code class="ruby">          rescue =&gt; e</code>
        </li>
      
        <li class="skipped" data-hits="0" data-linenumber="38">
          
          <span class="hits">skipped</span>
          <code class="ruby">            resolve.call(PromiseException.new(e))</code>
        </li>
      
        <li class="skipped" data-hits="" data-linenumber="39">
          
          <span class="hits">skipped</span>
          <code class="ruby">          # :nocov:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
